<div class="programmer-dashboard" *ngIf="programador; else sinProgramador">
  <div class="dashboard-header">
    <h1>Panel de programador</h1>
  </div>

  <!-- PERFIL RESUMEN -->
  <div class="card profile-card">
    <div class="card-body profile-content">
      <div class="avatar grande">
        <ng-container *ngIf="programador?.fotoUrl; else iconoPanel">
          <img
            [src]="programador.fotoUrl"
            [alt]="'Foto de ' + programador.nombre" />
        </ng-container>

        <ng-template #iconoPanel>
          <div class="avatar-icon">
            <i class="fas fa-user"></i>
          </div>
        </ng-template>
      </div>

      <div class="profile-info">
        <h2>{{ programador.nombre }}</h2>
        <p class="especialidad">{{ programador.especialidad }}</p>
        <p class="descripcion">{{ programador.descripcion }}</p>
      </div>
    </div>
  </div>

  <!-- MI PERFIL (EDICIÓN) -->
  <div class="card profile-edit-card">
    <div class="card-header">
      <h2>Mi perfil</h2>
    </div>
    <div class="card-body">
      <form (ngSubmit)="guardarPerfil()" #fPerfil="ngForm" class="form-estilizado">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre</label>
            <input
              type="text"
              name="nombre"
              [(ngModel)]="perfilForm.nombre"
              [readonly]="!perfilEditando"
              required />
          </div>

          <div class="form-group">
            <label>Especialidad</label>
            <input
              type="text"
              name="especialidad"
              [(ngModel)]="perfilForm.especialidad"
              [readonly]="!perfilEditando"
              required />
          </div>
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea
            name="descripcion"
            rows="3"
            [(ngModel)]="perfilForm.descripcion"
            [readonly]="!perfilEditando">
          </textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Correo de contacto</label>
            <input
              type="email"
              name="emailContacto"
              [(ngModel)]="perfilForm.emailContacto"
              [readonly]="!perfilEditando"
              placeholder="ejemplo@correo.com" />
          </div>

          <div class="form-group">
            <label>Sitio web / Portafolio personal</label>
            <input
              type="url"
              name="sitioWeb"
              [(ngModel)]="perfilForm.sitioWeb"
              [readonly]="!perfilEditando"
              placeholder="https://mi-sitio.dev" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>GitHub</label>
            <input
              type="url"
              name="githubUrl"
              [(ngModel)]="perfilForm.githubUrl"
              [readonly]="!perfilEditando"
              placeholder="https://github.com/usuario" />
          </div>

          <div class="form-group">
            <label>LinkedIn</label>
            <input
              type="url"
              name="linkedinUrl"
              [(ngModel)]="perfilForm.linkedinUrl"
              [readonly]="!perfilEditando"
              placeholder="https://www.linkedin.com/in/usuario" />
          </div>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="btn-guardar"
            *ngIf="!perfilEditando"
            (click)="editarPerfil()">
            Editar perfil
          </button>

          <ng-container *ngIf="perfilEditando">
            <button type="submit" class="btn-guardar" [disabled]="fPerfil.invalid">
              Guardar cambios
            </button>
            <button
              type="button"
              class="btn-cancelar"
              (click)="cancelarEdicionPerfil()">
              Cancelar
            </button>
          </ng-container>
        </div>
      </form>
    </div>
  </div>

  <!-- ASESORÍAS -->
  <div class="card table-card">
    <div class="card-header">
      <h2>Mis asesorías agendadas</h2>
    </div>

    <div class="card-body table-responsive">
      <table class="tabla-asesorias" *ngIf="asesorias.length; else sinAsesorias">
        <thead>
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Correo</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Estado</th>
            <th>Descripción</th>
            <th>Mensaje al cliente</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let a of asesorias">
            <td>{{ a.id }}</td>
            <td><strong>{{ a.nombreCliente }}</strong></td>
            <td>{{ a.emailCliente }}</td>
            <td>{{ a.fecha }}</td>
            <td>{{ a.hora }}</td>
            <td>
              <div class="select-wrapper">
                <select [(ngModel)]="a.estado">
                  <option *ngFor="let e of estadosPosibles" [ngValue]="e">
                    {{ e | titlecase }}
                  </option>
                </select>
              </div>
            </td>
            <td>
              <div class="desc-truncada" title="{{a.descripcionProyecto}}">
                {{ a.descripcionProyecto }}
              </div>
            </td>
            <td>
              <textarea
                rows="2"
                [(ngModel)]="a.mensajeRespuesta"
                placeholder="Escribe un mensaje corto para el cliente...">
              </textarea>
            </td>
            <td class="text-center">
              <button (click)="actualizarEstado(a)" class="btn-guardar">
                Guardar
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <ng-template #sinAsesorias>
        <div class="empty-state">
          <p>Todavía no tienes asesorías agendadas.</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- TOAST -->
  <div *ngIf="mensajeExito" class="toast-notification">
    <div class="toast-content">
      <i class="fas fa-check-circle"></i>
      <span>{{ mensajeExito }}</span>
    </div>
  </div>

  <!-- NOTIFICACIÓN SIMULADA -->
  <section class="notificacion-simulada" *ngIf="ultimaNotificacion">
    <h2>Notificación simulada al cliente</h2>

    <p>
      <strong>Para:</strong>
      {{ ultimaNotificacion.nombreCliente }} -
      {{ ultimaNotificacion.emailCliente }}
    </p>

    <p><strong>Estado:</strong> {{ ultimaNotificacion.estado }}</p>

    <p><strong>Mensaje que se enviaría (correo/WhatsApp):</strong></p>

    <ng-container *ngIf="ultimaNotificacion.mensajeRespuesta && ultimaNotificacion.mensajeRespuesta.trim(); else mensajePorDefecto">
      <p class="texto-notificacion">
        Hola {{ ultimaNotificacion.nombreCliente }},<br />
        {{ ultimaNotificacion.mensajeRespuesta }}
      </p>
    </ng-container>

    <ng-template #mensajePorDefecto>
      <p class="texto-notificacion">
        Hola {{ ultimaNotificacion.nombreCliente }},<br />
        Tu solicitud de asesoría con
        {{ programador.nombre }}
        para el día {{ ultimaNotificacion.fecha }} a las
        {{ ultimaNotificacion.hora }}
        ha sido <strong>{{ ultimaNotificacion.estado }}</strong>.
        <br />
      </p>
    </ng-template>
  </section>

  <!-- PROYECTOS -->
  <div class="card table-card">
    <div class="card-header">
      <h2>Mis proyectos</h2>
    </div>

    <div class="card-body">
      <div class="tabla-proyectos" *ngIf="programador?.proyectos?.length; else sinProyectos">
        <table class="tabla-asesorias">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Sección</th>
              <th>Rol</th>
              <th>Tecnologías</th>
              <th>Enlaces</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of programador?.proyectos">
              <td>{{ p.nombre }}</td>
              <td>{{ p.seccion | titlecase }}</td>
              <td>{{ p.participacion }}</td>
              <td>{{ p.tecnologias.join(', ') }}</td>
              <td>
                <div class="links-proyecto">
                  <a *ngIf="p.repoUrl" [href]="p.repoUrl" target="_blank">Repo</a>
                  <a *ngIf="p.demoUrl" [href]="p.demoUrl" target="_blank">Demo</a>
                </div>
              </td>
              <td class="text-center">
                <button (click)="editarProyecto(p)">Editar</button>
                <button (click)="eliminarProyecto(p)">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <ng-template #sinProyectos>
        <p class="text-muted">
          Aún no has registrado proyectos en tu portafolio.
        </p>
      </ng-template>

      <hr class="separador" />

      <h3>{{ editandoProyectoId == null ? 'Agregar nuevo proyecto' : 'Editar proyecto' }}</h3>

      <form (ngSubmit)="guardarProyecto()" #fProj="ngForm" class="form-estilizado">
        <div class="form-group">
          <label>Nombre del proyecto</label>
          <input
            type="text"
            name="nombreProyecto"
            [(ngModel)]="nuevoProyecto.nombre"
            required />
        </div>

        <div class="form-group">
          <label>Descripción</label>
          <textarea
            name="descripcionProyecto"
            rows="3"
            [(ngModel)]="nuevoProyecto.descripcion"
            required>
          </textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Sección</label>
            <select
              name="seccion"
              [(ngModel)]="nuevoProyecto.seccion"
              required>
              <option *ngFor="let s of tiposSeccion" [ngValue]="s">
                {{ s | titlecase }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Rol / Participación</label>
            <select
              name="participacion"
              [(ngModel)]="nuevoProyecto.participacion"
              required>
              <option *ngFor="let p of tiposParticipacion" [ngValue]="p">
                {{ p }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Tecnologías (separadas por coma)</label>
          <input
            type="text"
            name="tecnologias"
            [(ngModel)]="tecnologiasTexto"
            placeholder="Ej. Angular, Firebase, Tailwind" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>URL del repositorio (opcional)</label>
            <input
              type="url"
              name="repoUrl"
              [(ngModel)]="nuevoProyecto.repoUrl"
              placeholder="https://github.com/..." />
          </div>

          <div class="form-group">
            <label>URL de demo (opcional)</label>
            <input
              type="url"
              name="demoUrl"
              [(ngModel)]="nuevoProyecto.demoUrl"
              placeholder="https://..." />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" [disabled]="fProj.invalid" class="btn-guardar">
            {{ editandoProyectoId == null ? 'Guardar proyecto' : 'Actualizar proyecto' }}
          </button>

          <button
            type="button"
            *ngIf="editandoProyectoId != null"
            (click)="cancelarEdicion()"
            class="btn-cancelar">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<ng-template #sinProgramador>
  <div class="error-container">
    <p>No se encontró información del programador actual.</p>
  </div>
</ng-template>
